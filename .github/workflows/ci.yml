# .github/workflows/ci.yml
# GitHub Actions CI/CD Pipeline é…ç½®æª”

# å·¥ä½œæµç¨‹çš„åç¨±ï¼Œå°‡æœƒé¡¯ç¤ºåœ¨ GitHub Actions é é¢ä¸Š
name: CI Pipeline for SaaS Boilerplate

# å®šç¾©è§¸ç™¼é€™å€‹å·¥ä½œæµç¨‹çš„äº‹ä»¶
on:
  push:
    branches: [ main ] # ç•¶ç¨‹å¼ç¢¼è¢«æ¨é€åˆ° 'main' åˆ†æ”¯æ™‚è§¸ç™¼ã€‚é€™é€šå¸¸ç”¨æ–¼ç¨‹å¼ç¢¼åˆä½µå¾Œçš„æœ€çµ‚é©—è­‰ã€‚
  pull_request:
    branches: [ main ] # ç•¶æœ‰ Pull Request åˆä½µåˆ° 'main' åˆ†æ”¯æ™‚è§¸ç™¼ã€‚é€™æ˜¯ç¢ºä¿ PR å“è³ªçš„é—œéµé»ã€‚

# å®šç¾©è¦åŸ·è¡Œçš„ä»»å‹™ (Jobs)ã€‚ä¸€å€‹å·¥ä½œæµç¨‹å¯ä»¥åŒ…å«å¤šå€‹ä»»å‹™ã€‚
jobs:
  build-and-test: # ä»»å‹™åç¨±ï¼šå»ºç½®èˆ‡æ¸¬è©¦
    runs-on: ubuntu-latest # æŒ‡å®šé€™å€‹ä»»å‹™å°‡åœ¨ GitHub æä¾›çš„æœ€æ–°ç‰ˆ Ubuntu è™›æ“¬æ©Ÿä¸Šé‹è¡Œã€‚

    # å®šç¾©ä»»å‹™ä¸­çš„æ­¥é©Ÿ (Steps)ï¼Œæ¯å€‹æ­¥é©Ÿæœƒä¾åºåŸ·è¡Œã€‚
    steps:
      - name: ğŸš€ Checkout Code # æ­¥é©Ÿä¸€ï¼šæª¢å‡ºç¨‹å¼ç¢¼ - ç¢ºä¿æˆ‘å€‘æ‹¿åˆ°çš„æ˜¯æœ€æ–°çš„ç¨‹å¼ç¢¼
        uses: actions/checkout@v3 # ä½¿ç”¨ GitHub å®˜æ–¹æä¾›çš„ checkout Action

      - name: ğŸ³ Set up Docker Compose Environment # æ­¥é©ŸäºŒï¼šç’°å¢ƒæº–å‚™ - å•Ÿå‹• Docker æœå‹™
        run: |
          # ç”±æ–¼é€™å€‹ GitHub å€‰åº«æ˜¯ä¸€å€‹ã€Œæ¨£æ¿ã€ï¼Œæˆ‘å€‘åœ¨ CI ç’°å¢ƒä¸­éœ€è¦æ¨¡æ“¬ç”¨æˆ¶å¯¦éš›ä½¿ç”¨æ¨£æ¿çš„æµç¨‹ã€‚
          # å› æ­¤ï¼Œå°‡ç›®å‰çš„æ¨£æ¿æ–‡ä»¶è¤‡è£½åˆ°ä¸€å€‹å­ç›®éŒ„ `my-saas-app` ä¾†æ¨¡æ“¬å¯¦éš›å°ˆæ¡ˆã€‚
          mkdir -p my-saas-app
          cp -r . my-saas-app/ # è¤‡è£½æ•´å€‹å€‰åº«å…§å®¹åˆ°æ¨¡æ“¬çš„å°ˆæ¡ˆç›®éŒ„
          cd my-saas-app      # é€²å…¥æ¨¡æ“¬çš„å°ˆæ¡ˆç›®éŒ„

          # å°‡ .env.example è¤‡è£½ç‚º .envï¼Œé€™æ˜¯ Laravel æ‡‰ç”¨ç¨‹å¼é‹è¡Œæ‰€å¿…éœ€çš„ç’°å¢ƒè®Šæ•¸è¨­å®šæª”ã€‚
          # ç¢ºä¿æ‚¨çš„ .env.example åŒ…å«äº†æ‰€æœ‰ CI ç’°å¢ƒæ‰€éœ€çš„è®Šæ•¸ã€‚
          cp .env.example .env

          # ä½¿ç”¨ Docker Compose å•Ÿå‹•æ‰€æœ‰å®šç¾©åœ¨ docker-compose.yml ä¸­çš„æœå‹™ (å¦‚ app, mysql, redis)ã€‚
          # `--build` æœƒåœ¨å•Ÿå‹•å‰é‡å»º Docker æ˜ åƒï¼Œç¢ºä¿ä½¿ç”¨æœ€æ–°é…ç½®ã€‚
          # `--wait` æœƒç­‰å¾…æ‰€æœ‰æœå‹™éƒ½å•Ÿå‹•å®Œç•¢ï¼Œä¸¦é€šéå„è‡ªçš„å¥åº·æª¢æŸ¥ (healthcheck)ï¼Œé€™æ˜¯ç¢ºä¿æœå‹™çœŸæ­£ã€Œæ´»ã€äº†çš„é—œéµã€‚
          docker-compose up -d --build --wait 
        # è³‡æ·±æ€è€ƒï¼šé€™ä¸€æ­¥æ˜¯æ•´å€‹ CI ç’°å¢ƒçš„åŸºçŸ³ã€‚å®ƒä¿è­‰äº† CI é‹è¡Œç’°å¢ƒèˆ‡æ‚¨çš„æœ¬åœ°é–‹ç™¼ç’°å¢ƒä»¥åŠæœªä¾†çš„ç”Ÿç”¢ç’°å¢ƒé«˜åº¦ä¸€è‡´ï¼Œé¿å…ã€Œç’°å¢ƒå·®ç•°ã€é€ æˆçš„æ¸¬è©¦å¤±æ•—ã€‚

      - name: ğŸ“¦ Install Dependencies & Initialize Database # æ­¥é©Ÿä¸‰ï¼šå®‰è£ä¾è³´èˆ‡åˆå§‹åŒ–è³‡æ–™åº«
        working-directory: ./my-saas-app # æŒ‡å®šåœ¨æ¨¡æ“¬çš„å°ˆæ¡ˆç›®éŒ„ä¸­åŸ·è¡Œä»¥ä¸‹å‘½ä»¤
        run: |
          # åœ¨ `app` æœå‹™å®¹å™¨å…§åŸ·è¡Œ Composer å®‰è£ PHP ä¾è³´ã€‚
          docker-compose exec app composer install
          # åœ¨ `app` æœå‹™å®¹å™¨å…§åŸ·è¡Œ NPM å®‰è£ Node.js ä¾è³´ (ç”¨æ–¼å‰ç«¯è³‡ç”¢ç·¨è­¯å’Œ Playwright)ã€‚
          docker-compose exec app npm install
          # ç·¨è­¯å‰ç«¯è³‡ç”¢ (å¦‚ JavaScript, CSS)ï¼Œä¾‹å¦‚ä½¿ç”¨ Viteã€‚
          docker-compose exec app npm run build
          # ç”Ÿæˆ Laravel æ‡‰ç”¨ç¨‹å¼çš„ APP_KEYã€‚é€™æ˜¯ Laravel å®‰å…¨é‹è¡Œå’ŒåŠ å¯†çš„åŸºç¤ã€‚
          docker-compose exec app php artisan key:generate
          # é‹è¡Œè³‡æ–™åº«é·ç§»ä¸¦å¡«å……ç¯„ä¾‹æ•¸æ“šã€‚
          # `php artisan migrate --seed` æœƒæ ¹æ“šæ‚¨çš„ migrations æª”æ¡ˆå»ºç«‹æ‰€æœ‰è³‡æ–™åº«è¡¨æ ¼ï¼Œä¸¦é‹è¡Œ seeders å¡«å……æ¸¬è©¦æ•¸æ“šã€‚
          # è³‡æ·±æ€è€ƒï¼šç¢ºä¿æ¯æ¬¡æ¸¬è©¦å‰ï¼Œè³‡æ–™åº«éƒ½è™•æ–¼ä¸€å€‹ä¹¾æ·¨ä¸”é æœŸçš„ç‹€æ…‹ã€‚

      - name: ğŸŒ Add Local Hosts Entries for Multi-Tenancy Testing # æ­¥é©Ÿå››ï¼šç‚ºå¤šç§Ÿæˆ¶æ¸¬è©¦æ·»åŠ æœ¬åœ° hosts æ¢ç›® (é—œéµï¼è³‡æ·±å¿…å‚™)
        # åœ¨ GitHub Actions çš„ Runner (è™›æ“¬æ©Ÿ) ä¸Šï¼Œåƒ `tenant-a.localhost` é€™äº›è™›æ“¬åŸŸåé è¨­æ˜¯ç„¡æ³•è§£æçš„ã€‚
        # é€™å€‹æ­¥é©Ÿæœƒå°‡é€™äº›åŸŸåæ·»åŠ åˆ° Runner çš„ `/etc/hosts` æ–‡ä»¶ä¸­ï¼Œä¸¦æŒ‡å‘ `127.0.0.1` (å³ Docker æœå‹™çš„å®¿ä¸»æ©Ÿ)ã€‚
        # é€™æ¨£ï¼Œç•¶ Playwright å˜—è©¦è¨ªå•é€™äº›åŸŸåæ™‚ï¼Œå°±èƒ½æ­£ç¢ºè§£æä¸¦é€£æ¥åˆ° Docker å®¹å™¨è£¡çš„ Laravel æ‡‰ç”¨ç¨‹å¼ã€‚
        run: |
          echo "127.0.0.1 tenant-a.localhost" | sudo tee -a /etc/hosts
          echo "127.0.0.1 tenant-b.localhost" | sudo tee -a /etc/hosts
        # è³‡æ·±æ€è€ƒï¼šé€™ä¸€æ­¥å®Œç¾è§£æ±ºäº†å¤šç§Ÿæˆ¶æ‡‰ç”¨åœ¨ CI/CD ç’°å¢ƒä¸­ï¼Œå› åŸŸåè§£æå•é¡Œå°è‡´æ¸¬è©¦å¤±æ•—çš„å¸¸è¦‹ç—›é»ã€‚ç¢ºä¿æ¸¬è©¦ç’°å¢ƒèˆ‡å¯¦éš›é‹ä½œç’°å¢ƒçš„åŸŸåè§£æè¡Œç‚ºä¸€è‡´ã€‚

      - name: ğŸ§ª Run Playwright E2E Tests # æ­¥é©Ÿäº”ï¼šåŸ·è¡Œç«¯åˆ°ç«¯æ¸¬è©¦
        working-directory: ./my-saas-app # åœ¨æ¨¡æ“¬çš„å°ˆæ¡ˆç›®éŒ„ä¸­åŸ·è¡Œ
        run: |
          # å®‰è£ Playwright ç€è¦½å™¨æ ¸å¿ƒ (å¦‚ Chromium, Firefox, WebKit)ã€‚åœ¨ CI ç’°å¢ƒä¸­é¦–æ¬¡é‹è¡Œéœ€è¦ä¸‹è¼‰ã€‚
          docker-compose exec app npx playwright install --with-deps
          # åŸ·è¡Œæ‰€æœ‰ç«¯åˆ°ç«¯æ¸¬è©¦ã€‚é€™å°‡æœƒæ¨¡æ“¬çœŸå¯¦ç”¨æˆ¶æ“ä½œï¼Œå¾å‰ç«¯åˆ°å¾Œç«¯å®Œæ•´é©—è­‰æ‡‰ç”¨ç¨‹å¼ã€‚
          docker-compose exec app npm run test:e2e
          # (å¯é¸) å¦‚æœæ‚¨éœ€è¦ç”Ÿæˆæ¸¬è©¦å ±å‘Šä¸¦ä¸Šå‚³ç‚º Artifactsï¼Œå¯ä»¥å•Ÿç”¨ä»¥ä¸‹è¡Œã€‚
          # é€™æœ‰åŠ©æ–¼åœ¨ GitHub Actions ä»‹é¢ä¸­æŸ¥çœ‹è©³ç´°çš„æ¸¬è©¦å¤±æ•—æˆªåœ–æˆ–å½±ç‰‡ã€‚
          # docker-compose exec app npx playwright show-report --output playwright-report.zip
          # - uses: actions/upload-artifact@v3
          #   with:
          #     name: playwright-report
          #     path: my-saas-app/playwright-report.zip

      # TODO: (å¯é¸) å¦‚æœæ‚¨æœ‰å¯« PHPUnit çš„å–®å…ƒæ¸¬è©¦æˆ–åŠŸèƒ½æ¸¬è©¦ï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ æ­¥é©Ÿ
      # å»ºè­°å°‡ PHPUnit æ¸¬è©¦æ”¾åœ¨ E2E æ¸¬è©¦ä¹‹å‰ï¼Œå› ç‚ºå®ƒå€‘é€šå¸¸åŸ·è¡Œé€Ÿåº¦æ›´å¿«ï¼Œèƒ½æ›´æ—©ç™¼ç¾ç¨‹å¼ç¢¼å±¤é¢çš„å•é¡Œã€‚
      # - name: Run PHPUnit Tests
      #   working-directory: ./my-saas-app
      #   run: docker-compose exec app php artisan test

      # TODO: (å¯é¸) å¦‚æœæ‚¨æœ‰é›†æˆ Allure Report ç­‰å·¥å…·ä¾†ç”¢ç”Ÿæ¼‚äº®çš„æ¸¬è©¦å ±å‘Šï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ æ­¥é©Ÿ
      # - name: Generate Allure Report
      #   working-directory: ./my-saas-app
      #   run: docker-compose exec app npm run allure:generate # ç¢ºä¿æ‚¨çš„ package.json ä¸­æœ‰å®šç¾© 'allure:generate' è…³æœ¬

      # TODO: (æŒçºŒéƒ¨ç½² - CD éšæ®µ) å¦‚æœè¦å°‡æ‡‰ç”¨ç¨‹å¼è‡ªå‹•éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ æ­¥é©Ÿ
      # é€šå¸¸æœƒè¨­å®šåªæœ‰åœ¨ 'main' åˆ†æ”¯è¢« Push æ™‚æ‰è§¸ç™¼éƒ¨ç½²ã€‚
      # é€™æœƒæ¶‰åŠåˆ° SSH é€£æ¥é ç«¯ä¼ºæœå™¨ã€æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼ã€åŸ·è¡Œè³‡æ–™åº«é·ç§»ã€æ¸…é™¤å¿«å–å’Œé‡å•Ÿæœå‹™ç­‰æ“ä½œã€‚
      # - name: ğŸš€ Deploy to Production
      #   if: github.ref == 'refs/heads/main' # åªåœ¨ main åˆ†æ”¯æ¨é€åˆ°ç”Ÿç”¢ç’°å¢ƒ
      #   env: # åœ¨é€™è£¡å®‰å…¨åœ°å¼•ç”¨æ‚¨åœ¨ GitHub Secrets ä¸­è¨­å®šçš„æ•æ„Ÿè³‡è¨Š
      #     SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      #     PRODUCTION_SERVER_IP: ${{ secrets.PRODUCTION_SERVER_IP }}
      #   run: |
      #     # é€™è£¡çš„éƒ¨ç½²è…³æœ¬æœƒæ ¹æ“šæ‚¨çš„å¯¦éš›éƒ¨ç½²ç’°å¢ƒè€Œæœ‰æ‰€ä¸åŒ
      #     echo "Starting deployment to production environment..."
      #     # ç¯„ä¾‹ï¼šä½¿ç”¨ SSH é€£æ¥ä¸¦åŸ·è¡Œé ç«¯å‘½ä»¤
      #     ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no deploy_user@${{ env.PRODUCTION_SERVER_IP }} << 'EOF'
      #       cd /path/to/your/app
      #       git pull origin main
      #       composer install --no-dev --optimize-autoloader
      #       php artisan migrate --force
      #       php artisan config:cache
      #       php artisan route:cache
      #       php artisan view:cache
      #       sudo systemctl reload php8.2-fpm # ä¾æ“šæ‚¨çš„ä¼ºæœå™¨é…ç½®èª¿æ•´
      #     EOF
      #     echo "Deployment completed!"
